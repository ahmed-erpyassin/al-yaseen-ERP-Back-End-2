# تنفيذ البحث والتحديث والمعاينة والحذف لطلبيات صادرة - مكتمل

## ملخص التحديثات المنجزة

### 1. البحث المتقدم للطلبيات الصادرة (Advanced Search)

#### البحث بالحقول المتعددة:
- **رقم الطلبية الصادرة**: 
  - بحث بالرقم المحدد
  - بحث بالنطاق (من / إلى)
  - بحث جزئي بالرقم
- **اسم العميل**: 
  - بحث في اسم العميل
  - بحث في رقم العميل
  - بحث في جدول العملاء (الاسم الأول، الثاني، اسم الشركة)
- **التاريخ**: 
  - بحث بتاريخ محدد
  - بحث بنطاق التواريخ (من / إلى)
- **المبلغ**: 
  - بحث بمبلغ محدد
  - بحث بنطاق المبالغ (من / إلى)
- **العملة**: بحث بالعملة المحددة
- **المشغل المرخص**: بحث جزئي في اسم المشغل

#### البحث العام:
- **بحث شامل**: يبحث في جميع الحقول الرئيسية
- **بحث ذكي**: يدعم البحث الجزئي والكامل

### 2. الترتيب المتقدم (Advanced Sorting)

#### الحقول القابلة للترتيب:
- **معرف الطلبية** (ID)
- **رقم الطلبية الصادرة** (Outgoing Order Number)
- **اسم العميل** (Customer Name)
- **رقم العميل** (Customer Number)
- **التاريخ** (Date)
- **الوقت** (Time)
- **تاريخ الاستحقاق** (Due Date)
- **المشغل المرخص** (Licensed Operator)
- **المبلغ الإجمالي** (Total Amount)
- **المبلغ بدون ضريبة** (Total Without Tax)
- **مبلغ الضريبة** (Tax Amount)
- **سعر الصرف** (Exchange Rate)
- **الحالة** (Status)
- **رمز الدفتر** (Journal Code)
- **رقم الدفتر** (Journal Number)
- **تاريخ الإنشاء** (Created At)
- **تاريخ التحديث** (Updated At)

#### خيارات الترتيب:
- **تصاعدي** (ASC)
- **تنازلي** (DESC)
- **ترتيب افتراضي**: حسب تاريخ الإنشاء (تنازلي)

### 3. التحديث الكامل (Complete Update)

#### تحديث البيانات الأساسية:
- **معلومات العميل**: تحديث العميل مع التعبئة التلقائية
- **معلومات العملة**: تحديث العملة مع سعر الصرف المباشر
- **التواريخ والأوقات**: تحديث جميع التواريخ
- **المشغل المرخص**: تحديث المشغل
- **الملاحظات**: تحديث الملاحظات

#### تحديث العناصر:
- **حذف العناصر القديمة**: حذف جميع العناصر الموجودة
- **إضافة العناصر الجديدة**: إضافة العناصر المحدثة
- **إعادة حساب الإجماليات**: حساب تلقائي للمبالغ

#### قيود التحديث:
- **منع تحديث الطلبيات المفوترة**: لا يمكن تحديث الطلبيات بحالة "invoiced"
- **معاملات قاعدة البيانات**: ضمان تكامل البيانات
- **تسجيل المحدث**: تسجيل معرف المستخدم المحدث

### 4. المعاينة الشاملة (Complete Preview)

#### عرض البيانات الأساسية:
- **معلومات الطلبية**: رقم الطلبية، التاريخ، الوقت
- **معلومات العميل**: الاسم، الرقم، الإيميل، الموبايل
- **معلومات العملة**: العملة، سعر الصرف
- **معلومات المالية**: المبالغ، الضرائب، الخصومات

#### عرض العناصر:
- **تفاصيل العناصر**: الاسم، الكمية، السعر، الإجمالي
- **معلومات الوحدات**: وحدة القياس لكل صنف
- **الخصومات**: خصومات العناصر الفردية

#### معلومات إضافية:
- **معلومات التدقيق**: المنشئ، المحدث، التواريخ
- **معلومات الشركة**: الشركة، الفرع، الموظف
- **معلومات الدفتر**: رمز الدفتر، رقم الفاتورة

#### القيم المنسقة:
- **تنسيق التواريخ**: dd/mm/yyyy
- **تنسيق الأوقات**: HH:mm
- **تنسيق المبالغ**: مع الفواصل العشرية
- **تسميات الحالة**: عرض أسماء الحالات بدلاً من الرموز

### 5. الحذف الآمن (Soft Delete)

#### حذف الطلبيات:
- **حذف ناعم**: استخدام SoftDeletes trait
- **حفظ سجل المحذوف**: تسجيل معرف المستخدم الحاذف
- **حذف العناصر المرتبطة**: حذف تلقائي للعناصر

#### قيود الحذف:
- **منع حذف الطلبيات المفوترة**: لا يمكن حذف الطلبيات بحالة "invoiced"
- **معاملات قاعدة البيانات**: ضمان تكامل العملية

#### استرداد الطلبيات:
- **استرداد الطلبيات المحذوفة**: إمكانية استرداد الطلبيات
- **عرض الطلبيات المحذوفة**: قائمة منفصلة للطلبيات المحذوفة
- **بحث في المحذوفات**: نفس خيارات البحث للطلبيات المحذوفة

### 6. نقاط النهاية الجديدة (New API Endpoints)

#### العمليات الأساسية:
```
GET    /api/v1/purchase/outgoing-orders           # قائمة الطلبيات مع البحث والترتيب
POST   /api/v1/purchase/outgoing-orders           # إنشاء طلبية جديدة
GET    /api/v1/purchase/outgoing-orders/{id}      # عرض طلبية محددة
PUT    /api/v1/purchase/outgoing-orders/{id}      # تحديث طلبية
DELETE /api/v1/purchase/outgoing-orders/{id}      # حذف طلبية
```

#### إدارة الحذف الناعم:
```
GET  /api/v1/purchase/outgoing-orders/deleted/list    # قائمة الطلبيات المحذوفة
POST /api/v1/purchase/outgoing-orders/{id}/restore    # استرداد طلبية محذوفة
```

#### الخدمات المساعدة:
```
GET /api/v1/purchase/outgoing-orders/helpers/customers           # قائمة العملاء
GET /api/v1/purchase/outgoing-orders/helpers/items              # قائمة الأصناف
GET /api/v1/purchase/outgoing-orders/helpers/currencies         # قائمة العملات
GET /api/v1/purchase/outgoing-orders/helpers/tax-rates          # معدلات الضريبة
GET /api/v1/purchase/outgoing-orders/helpers/live-exchange-rate # سعر صرف مباشر
GET /api/v1/purchase/outgoing-orders/helpers/form-data          # بيانات النماذج
GET /api/v1/purchase/outgoing-orders/helpers/search-form-data   # بيانات نماذج البحث
GET /api/v1/purchase/outgoing-orders/helpers/sortable-fields    # الحقول القابلة للترتيب
```

### 7. تحسينات الأداء والأمان

#### الأداء:
- **فهارس قاعدة البيانات**: فهارس على الحقول المستخدمة في البحث
- **تحميل العلاقات**: eager loading للعلاقات المطلوبة
- **ترقيم النتائج**: pagination مع حد أقصى 100 عنصر لكل صفحة
- **تحسين الاستعلامات**: استعلامات محسنة للبحث والترتيب

#### الأمان:
- **حماية من SQL Injection**: استخدام Eloquent ORM
- **تحقق من الصلاحيات**: middleware auth:sanctum
- **تحقق من البيانات**: validation شامل للمدخلات
- **معاملات قاعدة البيانات**: ضمان تكامل البيانات

### 8. معالجة الأخطاء

#### رسائل خطأ واضحة:
- **أخطاء البحث**: رسائل واضحة لأخطاء البحث
- **أخطاء التحديث**: رسائل محددة لقيود التحديث
- **أخطاء الحذف**: رسائل واضحة لقيود الحذف
- **أخطاء النظام**: معالجة شاملة للأخطاء غير المتوقعة

#### تسجيل الأخطاء:
- **تسجيل تفصيلي**: تسجيل جميع الأخطاء مع التفاصيل
- **معلومات السياق**: تسجيل معلومات المستخدم والطلب
- **تتبع الأخطاء**: إمكانية تتبع مصدر الأخطاء

### 9. الملفات المحدثة

#### الخدمات (Services):
- **OutgoingOrderService.php**: تحديث شامل مع جميع الوظائف الجديدة
  - `index()` - بحث وترتيب متقدم
  - `show()` - عرض تفصيلي
  - `update()` - تحديث كامل
  - `destroy()` - حذف ناعم
  - `restore()` - استرداد
  - `getDeleted()` - قائمة المحذوفات
  - `getSearchFormData()` - بيانات نماذج البحث
  - `getSortableFields()` - الحقول القابلة للترتيب

#### المتحكمات (Controllers):
- **OutgoingOrderController.php**: تحديث شامل مع جميع endpoints
  - جميع عمليات CRUD
  - إدارة الحذف الناعم
  - الخدمات المساعدة

#### الموارد (Resources):
- **OutgoingOrderResource.php**: تحسين شامل لعرض البيانات
  - جميع الحقول مع التنسيق
  - القيم المحسوبة
  - معلومات العلاقات

#### المسارات (Routes):
- **api.php**: إضافة جميع المسارات الجديدة
  - مسارات CRUD كاملة
  - مسارات الحذف الناعم
  - مسارات الخدمات المساعدة

### 10. حالة التنفيذ النهائية

✅ **البحث المتقدم**: مكتمل مع جميع الحقول المطلوبة
✅ **الترتيب الديناميكي**: مكتمل لجميع الحقول
✅ **التحديث الكامل**: مكتمل مع قيود الأمان
✅ **المعاينة الشاملة**: مكتملة مع جميع البيانات
✅ **الحذف الآمن**: مكتمل مع الاسترداد
✅ **نقاط النهاية**: مكتملة جميع APIs
✅ **معالجة الأخطاء**: شاملة ومفصلة
✅ **الأداء والأمان**: محسن ومؤمن
✅ **حذف الموردين الناعم**: مكتمل ويعمل بشكل صحيح

**🎯 تم تنفيذ جميع متطلبات البحث والتحديث والمعاينة والحذف بنجاح!**

## أمثلة الاستخدام

### 1. البحث المتقدم:
```bash
GET /api/v1/purchase/outgoing-orders?order_number_from=OUT-0001&order_number_to=OUT-0100&customer_name=أحمد&date_from=2025-01-01&date_to=2025-01-31&amount_from=1000&amount_to=5000&currency_id=1&licensed_operator=محمد&sort_by=date&sort_order=desc&per_page=20
```

### 2. عرض طلبية محددة:
```bash
GET /api/v1/purchase/outgoing-orders/1
```

### 3. تحديث طلبية:
```bash
PUT /api/v1/purchase/outgoing-orders/1
```

### 4. حذف طلبية:
```bash
DELETE /api/v1/purchase/outgoing-orders/1
```

### 5. استرداد طلبية محذوفة:
```bash
POST /api/v1/purchase/outgoing-orders/1/restore
```

جميع الوظائف تعمل بشكل كامل ومتكامل! 🚀
